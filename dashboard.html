<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Tracker Dashboard</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Font: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        /* Use Inter as the default font */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for Chart.js responsive container */
        .chart-container {
            position: relative;
            height: 350px;
            width: 100%;
        }
        /* Custom scrollbar for modals */
        .modal-content::-webkit-scrollbar {
            width: 8px;
        }
        .modal-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .modal-content::-webkit-scrollbar-thumb {
            background: #a8a8a8;
            border-radius: 10px;
        }
        .modal-content::-webkit-scrollbar-thumb:hover {
            background: #888;
        }
        .dark .modal-content::-webkit-scrollbar-track {
            background: #2d3748;
        }
        .dark .modal-content::-webkit-scrollbar-thumb {
            background: #4a5568;
        }
        .dark .modal-content::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }

        /* Classes for period tabs */
        .period-tab {
            background-color: #f3f4f6; /* bg-slate-100 */
            color: #374151; /* text-slate-700 */
        }
        .dark .period-tab {
            background-color: #334155; /* dark:bg-slate-700 */
            color: #d1d5db; /* dark:text-slate-300 */
        }
        .period-tab:hover {
            background-color: #e5e7eb; /* hover:bg-slate-200 */
        }
        .dark .period-tab:hover {
            background-color: #4b5563; /* dark:hover:bg-slate-600 */
        }
        .period-tab.active {
            background-color: #2563eb; /* bg-blue-600 */
            color: #ffffff; /* text-white */
        }
        .dark .period-tab.active {
            background-color: #2563eb; /* dark:bg-blue-600 */
            color: #ffffff; /* dark:text-white */
        }
        .period-tab.active:hover {
            background-color: #1d4ed8; /* hover:bg-blue-700 */
        }
        .dark .period-tab.active:hover {
            background-color: #1d4ed8; /* dark:hover:bg-blue-700 */
        }
    </style>
    <script>
        // Configure Tailwind for dark mode
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-900 dark:text-slate-200 antialiased">

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 z-[1001] flex items-center w-full max-w-xs p-4 rounded-lg shadow-lg text-slate-700 bg-white dark:text-slate-300 dark:bg-slate-800 border dark:border-slate-700 transition-transform translate-x-[120%]" role="alert">
        <div id="toastIcon" class="text-2xl"></div>
        <div id="toastMessage" class="ml-3 text-sm font-medium"></div>
    </div>

    <!-- Confirmation Modal (Replaces confirm() and prompt()) -->
    <div id="confirmationModal" class="fixed inset-0 z-[1000] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4" style="display: none;">
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-xl w-full max-w-md">
            <div class="p-6">
                <h3 id="confirmTitle" class="text-lg font-semibold text-slate-900 dark:text-white">Confirmation</h3>
                <p id="confirmMessage" class="mt-2 text-sm text-slate-600 dark:text-slate-400">Are you sure?</p>
                
                <!-- Input field for confirmation text (e.g., "DELETE ALL") -->
                <div id="confirmInputWrapper" class="mt-4" style="display: none;">
                    <label for="confirmInput" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Please type to confirm</label>
                    <input type="text" id="confirmInput" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
            </div>
            <div class="bg-slate-50 dark:bg-slate-800/50 px-6 py-4 flex justify-end space-x-3 rounded-b-lg">
                <button id="confirmCancelBtn" type="button" class="py-2 px-4 bg-white dark:bg-slate-700 text-slate-700 dark:text-slate-300 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm text-sm font-medium hover:bg-slate-50 dark:hover:bg-slate-600 focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-slate-800 focus:ring-slate-400 transition-all">
                    Cancel
                </button>
                <button id="confirmOkBtn" type="button" class="py-2 px-4 bg-red-600 text-white border border-transparent rounded-md shadow-sm text-sm font-medium hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-slate-800 focus:ring-red-500 transition-all">
                    Confirm
                </button>
            </div>
        </div>
    </div>

    <div class="app-container max-w-7xl mx-auto p-4 md:p-6">
        
        <!-- Top Navigation -->
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-md border dark:border-slate-700 p-4 mb-6">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-3">
                    <div id="userAvatar" class="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center text-xl font-bold text-white">L</div>
                    <div>
                        <h3 id="userName" class="text-lg font-semibold text-slate-900 dark:text-white">Loading...</h3>
                        <p id="userRole" class="text-sm font-medium text-blue-600 dark:text-blue-400">...</p>
                    </div>
                </div>
                <div class="flex flex-wrap justify-center md:justify-end gap-2">
                    <button id="btnUsers" style="display: none;" class="flex items-center gap-2 py-2 px-4 bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 text-sm font-medium rounded-lg transition-all">üë• Manage Admins</button>
                    <button id="btnProducts" style="display: none;" class="flex items-center gap-2 py-2 px-4 bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 text-sm font-medium rounded-lg transition-all">üì¶ Manage Products</button>
                    <button id="btnCalculator" class="flex items-center gap-2 py-2 px-4 bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 text-sm font-medium rounded-lg transition-all">üßÆ Calculator</button>
                    <button id="btnSettings" class="flex items-center gap-2 py-2 px-4 bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 text-sm font-medium rounded-lg transition-all">‚öôÔ∏è Settings</button>
                    <button id="btnDark" class="flex items-center gap-2 py-2 px-4 bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 text-sm font-medium rounded-lg transition-all">üåô</button>
                    <button id="btnLogout" class="flex items-center gap-2 py-2 px-4 bg-red-100 dark:bg-red-900/40 hover:bg-red-200 dark:hover:bg-red-900/60 text-red-600 dark:text-red-400 text-sm font-medium rounded-lg transition-all">üö™ Logout</button>
                </div>
            </div>
        </div>

        <!-- App Header -->
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-md border dark:border-slate-700 p-6 md:p-8 mb-6">
            <div class="flex items-center gap-5">
                <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl flex items-center justify-center shadow-lg flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" />
                    </svg>
                </div>
                <div>
                    <h1 class="text-3xl font-bold text-slate-900 dark:text-white">Sales Dashboard</h1>
                    <p id="dashboardSubtitle" class="text-lg text-slate-500 dark:text-slate-400 mt-1">Loading dashboard...</p>
                </div>
            </div>
        </div>

        <!-- Period Tabs -->
        <div class="mb-6">
            <div class="flex flex-wrap gap-2" role="group">
                <button data-period="all" class="period-tab active py-2 px-5 text-sm font-medium rounded-lg transition-all">üìä All Time</button>
                <button data-period="today" class="period-tab py-2 px-5 text-sm font-medium rounded-lg transition-all">üìÖ Today</button>
                <button data-period="week" class="period-tab py-2 px-5 text-sm font-medium rounded-lg transition-all">üìÜ This Week</button>
                <button data-period="month" class="period-tab py-2 px-5 text-sm font-medium rounded-lg transition-all">üóìÔ∏è This Month</button>
            </div>
        </div>

        <!-- Dashboard Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-6 mb-6">
            <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md border dark:border-slate-700">
                <div class="text-sm font-medium text-slate-500 dark:text-slate-400 mb-2">Total Sales</div>
                <div id="totalSales" class="text-3xl font-bold text-blue-600 dark:text-blue-400">‚Ç±0.00</div>
            </div>
            <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md border dark:border-slate-700">
                <div class="text-sm font-medium text-slate-500 dark:text-slate-400 mb-2">My Earnings</div>
                <div id="myEarnings" class="text-3xl font-bold text-green-600 dark:text-green-400">‚Ç±0.00</div>
            </div>
            <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md border dark:border-slate-700">
                <div class="text-sm font-medium text-slate-500 dark:text-slate-400 mb-2">Items Sold</div>
                <div id="itemsSold" class="text-3xl font-bold text-slate-900 dark:text-white">0</div>
            </div>
            <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md border dark:border-slate-700">
                <div class="text-sm font-medium text-slate-500 dark:text-slate-400 mb-2">Total Products</div>
                <div id="totalProducts" class="text-3xl font-bold text-slate-900 dark:text-white">0</div>
            </div>
            <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md border dark:border-slate-700">
                <div class="text-sm font-medium text-slate-500 dark:text-slate-400 mb-2">Average Sale</div>
                <div id="avgSale" class="text-3xl font-bold text-slate-900 dark:text-white">‚Ç±0.00</div>
            </div>
            <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md border dark:border-slate-700">
                <div class="text-sm font-medium text-slate-500 dark:text-slate-400 mb-2">Profit Rate</div>
                <div id="profitRate" class="text-3xl font-bold text-slate-900 dark:text-white">--%</div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-6 mb-6">
            <div class="lg:col-span-3 bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md border dark:border-slate-700">
                <h3 class="text-lg font-semibold mb-4 text-slate-900 dark:text-white">Sales Overview</h3>
                <div class="chart-container">
                    <canvas id="salesChart"></canvas>
                </div>
            </div>
            <div class="lg:col-span-2 bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md border dark:border-slate-700">
                <h3 class="text-lg font-semibold mb-4 text-slate-900 dark:text-white">Warranty Distribution</h3>
                <div class="chart-container" style="height: 300px; margin-top: 40px;">
                    <canvas id="warrantyChart"></canvas>
                </div>
            </div>
        </div>

        <!-- ADD SALE FORM -->
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-md border dark:border-slate-700 p-6 md:p-8 mb-6">
            <h3 id="saleFormTitle" class="text-2xl font-bold text-slate-900 dark:text-white mb-6">Add New Sale</h3>
            <form id="addSaleForm" class="max-w-2xl mx-auto space-y-5">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div>
                        <label for="productSelect" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Product</label>
                        <select id="productSelect" required class="form-input">
                            <option value="">-- Select Product --</option>
                        </select>
                    </div>
                    <div>
                        <label for="productQuantity" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Quantity</label>
                        <input type="number" id="productQuantity" value="1" min="1" required class="form-input">
                    </div>
                </div>

                <!-- Product Details -->
                <div id="productDetailsCard" class="p-4 bg-slate-50 dark:bg-slate-700/50 rounded-lg space-y-2 border dark:border-slate-700" style="display: none;">
                    <h4 class="font-semibold text-center text-slate-800 dark:text-slate-200 mb-2">Calculation Details</h4>
                    <div class="flex justify-between text-sm"><span class="text-slate-600 dark:text-slate-400">Buy Price:</span> <span id="displayBuyPrice" class="font-medium">‚Ç±0.00</span></div>
                    <div class="flex justify-between text-sm"><span class="text-slate-600 dark:text-slate-400">Sell Price (Base):</span> <span id="displaySellPrice" class="font-medium">‚Ç±0.00</span></div>
                    <div class="flex justify-between text-sm"><span class="text-slate-600 dark:text-slate-400">Your Rate:</span> <span id="displayCommission" class="font-medium">0%</span></div>
                    <hr class="border-slate-200 dark:border-slate-600 my-1">
                    <div class="flex justify-between text-md font-semibold"><span class="text-slate-700 dark:text-slate-300">Your Price (per item):</span> <span id="displayYourPrice" class="text-blue-600 dark:text-blue-400">‚Ç±0.00</span></div>
                    <div class="flex justify-between text-md font-semibold"><span class="text-slate-700 dark:text-slate-300">Your Profit (per item):</span> <span id="displayCommissionAmount" class="text-green-600 dark:text-green-400">‚Ç±0.00</span></div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Warranty Type</label>
                    <div class="flex gap-3">
                        <label for="warrantyFW" class="flex-1 p-4 border dark:border-slate-600 rounded-lg cursor-pointer has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-slate-700 has-[:checked]:border-blue-500 dark:has-[:checked]:border-blue-500 transition-all">
                            <input type="radio" id="warrantyFW" name="warranty" value="FW" class="sr-only" required>
                            <span class="font-medium text-slate-800 dark:text-slate-200">‚úÖ FW (Full Warranty)</span>
                        </label>
                        <label for="warrantyNW" class="flex-1 p-4 border dark:border-slate-600 rounded-lg cursor-pointer has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-slate-700 has-[:checked]:border-blue-500 dark:has-[:checked]:border-blue-500 transition-all">
                            <input type="radio" id="warrantyNW" name="warranty" value="NW" class="sr-only">
                            <span class="font-medium text-slate-800 dark:text-slate-200">‚ö†Ô∏è NW (No Warranty)</span>
                        </label>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Account Type</label>
                    <div class="flex gap-3">
                        <label for="accountSolo" class="flex-1 p-4 border dark:border-slate-600 rounded-lg cursor-pointer has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-slate-700 has-[:checked]:border-blue-500 dark:has-[:checked]:border-blue-500 transition-all">
                            <input type="radio" id="accountSolo" name="accountType" value="Solo" class="sr-only" required>
                            <span class="font-medium text-slate-800 dark:text-slate-200">üë§ Solo</span>
                        </label>
                        <label for="accountShared" class="flex-1 p-4 border dark:border-slate-600 rounded-lg cursor-pointer has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-slate-700 has-[:checked]:border-blue-500 dark:has-[:checked]:border-blue-500 transition-all">
                            <input type="radio" id="accountShared" name="accountType" value="Shared" class="sr-only">
                            <span class="font-medium text-slate-800 dark:text-slate-200">üë• Shared</span>
                        </label>
                    </div>
                </div>

                <div>
                    <label for="productSoldStatus" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Sold Status</label>
                    <select id="productSoldStatus" class="form-input">
                        <option value="no">‚ùå No - In Stock</option>
                        <option value="yes">‚úÖ Yes - Sold</option>
                    </select>
                </div>
                
                <!-- Total Earnings -->
                <div id="totalEarningsCard" class="p-4 bg-green-50 dark:bg-green-900/40 rounded-lg space-y-2 border border-green-300 dark:border-green-700" style="display: none;">
                    <div class="flex justify-between text-lg font-semibold"><span class="text-slate-700 dark:text-slate-300">Total Sale:</span> <span id="displayTotalSale" class="text-green-700 dark:text-green-300">‚Ç±0.00</span></div>
                    <div class="flex justify-between text-lg font-bold"><span class="text-slate-800 dark:text-slate-200">Total Profit:</span> <span id="displayTotalEarn" class="text-green-600 dark:text-green-300">‚Ç±0.00</span></div>
                </div>
                
                <input type="hidden" id="productPrice" value="0">

                <div class="flex gap-4">
                    <button type="button" id="cancelEditBtn" onclick="resetSaleForm()" class="w-1/3 py-3 px-4 bg-slate-200 dark:bg-slate-600 hover:bg-slate-300 dark:hover:bg-slate-500 text-slate-700 dark:text-slate-200 font-semibold rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-slate-400 focus:ring-offset-2 dark:focus:ring-offset-slate-800 transition-all" style="display: none;">
                        Cancel
                    </button>
                    <button type="submit" id="submitSaleBtn" class="flex-1 w-full py-3 px-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-slate-800 transition-all">
                        ‚ûï Add Sale
                    </button>
                </div>
            </form>
        </div>

        <!-- Sales Table -->
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-md border dark:border-slate-700 p-6 md:p-8 mb-6">
            <h3 class="text-2xl font-bold text-slate-900 dark:text-white mb-6">Sales History</h3>
            
            <div class="flex flex-col md:flex-row gap-4 mb-4">
                <div class="relative flex-grow">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="w-5 h-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                    </div>
                    <input type="text" id="searchInput" placeholder="Search sales..." class="form-input pl-10 w-full">
                </div>
                <select id="userFilter" class="form-input">
                    <option value="all">All Admins</option>
                </select>
                <div class="flex-shrink-0 flex gap-2">
                    <button id="filterAll" class="filter-btn active py-2 px-4 text-sm font-medium rounded-lg">All</button>
                    <button id="filterSold" class="filter-btn py-2 px-4 text-sm font-medium rounded-lg">Sold</button>
                    <button id="filterStock" class="filter-btn py-2 px-4 text-sm font-medium rounded-lg">In Stock</button>
                </div>
                <button id="btnExport" class="py-2 px-4 bg-green-100 dark:bg-green-900/40 text-green-700 dark:text-green-300 hover:bg-green-200 dark:hover:bg-green-900/60 font-medium rounded-lg transition-all text-sm">üì• Export CSV</button>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full min-w-[800px] text-left">
                    <thead>
                        <tr class="bg-slate-50 dark:bg-slate-700/50">
                            <th class="p-4 text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Date</th>
                            <th id="adminColumn" class="p-4 text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Admin</th>
                            <th class="p-4 text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Product</th>
                            <th class="p-4 text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Warranty</th>
                            <th class="p-4 text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Type</th>
                            <th class="p-4 text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Qty</th>
                            <th class="p-4 text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Price</th>
                            <th class="p-4 text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Total</th>
                            <th class="p-4 text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Sold</th>
                            <th class="p-4 text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="salesTableBody" class="divide-y divide-slate-200 dark:divide-slate-700">
                        <tr>
                            <td colspan="10" class="p-6 text-center text-slate-500 dark:text-slate-400">
                                <div class="text-center p-6">
                                    <svg class="mx-auto h-12 w-12 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" /></svg>
                                    <h3 class="mt-2 text-sm font-medium text-slate-900 dark:text-white">No sales yet</h3>
                                    <p class="mt-1 text-sm text-slate-500">Add your first sale to get started!</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Product Management Modal (Owner Only) -->
    <div id="productModal" class="fixed inset-0 z-[1000] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4" style="display: none;">
        <div class="modal-content bg-white dark:bg-slate-800 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white dark:bg-slate-800 p-6 border-b dark:border-slate-700 flex justify-between items-center">
                <h2 class="text-2xl font-bold text-slate-900 dark:text-white">Manage Products</h2>
                <button onclick="closeModal('productModal')" class="w-8 h-8 flex items-center justify-center text-slate-500 hover:text-slate-800 dark:hover:text-slate-200 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 transition-all">‚úï</button>
            </div>
            
            <div class="p-6 space-y-6">
                <div>
                    <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-4">Add New Product</h3>
                    <form id="addProductForm" class="space-y-4">
                        <div>
                            <label for="productNameSelect" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Product Name</label>
                            <select id="productNameSelect" onchange="handleProductNameSelect()" class="form-input">
                                <option value="">-- Select Popular App --</option>
                                <!-- All your <optgroup> and <option> tags go here -->
                                <optgroup label="üé¨ Streaming Services">
                                    <option value="Netflix">Netflix</option>
                                    <option value="Disney+">Disney+</option>
                                    <option value="HBO Max">HBO Max</option>
                                    <option value="Amazon Prime Video">Amazon Prime Video</option>
                                    <option value="Hulu">Hulu</option>
                                    <option value="Paramount+">Paramount+</option>
                                    <option value="Apple TV+">Apple TV+</option>
                                    <option value="Peacock">Peacock</option>
                                    <option value="Crunchyroll">Crunchyroll</option>
                                </optgroup>
                                <optgroup label="‚úÇÔ∏è Design & Editing">
                                    <option value="CapCut Pro">CapCut Pro</option>
                                    <option value="Canva Pro">Canva Pro</option>
                                    <option value="Adobe Creative Cloud">Adobe Creative Cloud</option>
                                    <option value="Photoshop">Photoshop</option>
                                    <option value="Premiere Pro">Premiere Pro</option>
                                    <option value="After Effects">After Effects</option>
                                    <option value="Figma">Figma</option>
                                    <option value="Lightroom">Lightroom</option>
                                </optgroup>
                                <optgroup label="üéµ Music Apps">
                                    <option value="Spotify Premium">Spotify Premium</option>
                                    <option value="Apple Music">Apple Music</option>
                                    <option value="YouTube Music">YouTube Music</option>
                                    <option value="Tidal">Tidal</option>
                                    <option value="Deezer">Deezer</option>
                                </optgroup>
                                <optgroup label="üìö Education">
                                    <option value="Quizlet Plus">Quizlet Plus</option>
                                    <option value="Duolingo Plus">Duolingo Plus</option>
                                    <option value="Coursera Plus">Coursera Plus</option>
                                    <option value="Udemy">Udemy</option>
                                    <option value="Skillshare">Skillshare</option>
                                    <option value="Brainly">Brainly</option>
                                </optgroup>
                                <optgroup label="üéÆ Gaming">
                                    <option value="Xbox Game Pass">Xbox Game Pass</option>
                                    <option value="PlayStation Plus">PlayStation Plus</option>
                                    <option value="Nintendo Switch Online">Nintendo Switch Online</option>
                                    <option value="EA Play">EA Play</option>
                                    <option value="Ubisoft+">Ubisoft+</option>
                                </optgroup>
                                <optgroup label="üîê VPN & Security">
                                    <option value="NordVPN">NordVPN</option>
                                    <option value="ExpressVPN">ExpressVPN</option>
                                    <option value="Surfshark">Surfshark</option>
                                    <option value="CyberGhost">CyberGhost</option>
                                    <option value="ProtonVPN">ProtonVPN</option>
                                </optgroup>
                                <optgroup label="‚òÅÔ∏è Cloud Storage">
                                    <option value="Google One">Google One</option>
                                    <option value="Dropbox">Dropbox</option>
                                    <option value="OneDrive">OneDrive</option>
                                    <option value="iCloud+">iCloud+</option>
                                </optgroup>
                                <optgroup label="üíº Productivity">
                                    <option value="Microsoft 365">Microsoft 365</option>
                                    <option value="Notion">Notion</option>
                                    <option value="Grammarly Premium">Grammarly Premium</option>
                                    <option value="ChatGPT Plus">ChatGPT Plus</option>
                                    <option value="Evernote Premium">Evernote Premium</option>
                                </optgroup>
                                <optgroup label="üì± Social & Other">
                                    <option value="YouTube Premium">YouTube Premium</option>
                                    <option value="LinkedIn Premium">LinkedIn Premium</option>
                                    <option value="Telegram Premium">Telegram Premium</option>
                                    <option value="Discord Nitro">Discord Nitro</option>
                                </optgroup>
                                <option value="custom">‚úèÔ∏è Custom / Other</option>
                            </select>
                        </div>
                        <input type="text" id="newProductName" placeholder="Or type custom product name" class="form-input mt-2" style="display: none;">

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="newBuyPrice" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Buy Price (‚Ç±)</label>
                                <input type="number" id="newBuyPrice" placeholder="0.00" step="0.01" min="0" required class="form-input">
                            </div>
                            <div>
                                <label for="newSellPrice" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Sell Price (‚Ç±)</label>
                                <input type="number" id="newSellPrice" placeholder="0.00" step="0.01" min="0" required class="form-input">
                            </div>
                        </div>
                        
                        <div>
                            <label for="newMargin" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Margin (%) <span class="text-green-600 text-xs">‚úì Auto-Calculated</span></label>
                            <input type="text" id="newMargin" placeholder="--" readonly class="form-input bg-slate-100 dark:bg-slate-700 text-green-600 dark:text-green-400 font-bold cursor-not-allowed">
                        </div>
                        
                        <div id="productCalculation" class="p-4 bg-slate-50 dark:bg-slate-700/50 rounded-lg space-y-2 border dark:border-slate-700" style="display: none;">
                            <h4 class="font-semibold text-center text-slate-800 dark:text-slate-200 mb-2">Profit Preview</h4>
                            <div class="flex justify-between text-sm"><span class="text-slate-600 dark:text-slate-400">Your Profit Per Sale:</span> <span id="autoProfit" class="font-bold text-green-600 dark:text-green-400">‚Ç±0.00</span></div>
                            <div class="flex justify-between text-sm"><span class="text-slate-600 dark:text-slate-400">Profit Margin:</span> <span id="autoProfitPercent" class="font-medium">0%</span></div>
                            <hr class="border-slate-200 dark:border-slate-600 my-2">
                            <div class="flex justify-between text-xs"><span class="text-slate-500 dark:text-slate-400">Admin Price (20% comm):</span> <span id="autoAdminPrice20" class="font-medium">‚Ç±0.00</span></div>
                            <div class="flex justify-between text-xs"><span class="text-slate-500 dark:text-slate-400">Admin Price (30% comm):</span> <span id="autoAdminPrice30" class="font-medium">‚Ç±0.00</span></div>
                        </div>
                        
                        <button type="submit" class="w-full py-3 px-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-slate-800 transition-all">
                            ‚ûï Add Product
                        </button>
                    </form>
                </div>

                <hr class="border-slate-200 dark:border-slate-700">

                <div>
                    <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-4">Current Products</h3>
                    <div id="productList" class="space-y-3">
                        <!-- Product list will be rendered here -->
                        <div class="text-center p-6 text-slate-500 dark:text-slate-400">No products yet.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Calculator Modal -->
    <div id="calculatorModal" class="fixed inset-0 z-[1000] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4" style="display: none;">
        <div class="modal-content bg-white dark:bg-slate-800 rounded-lg shadow-xl w-full max-w-xs overflow-y-auto">
            <div class="sticky top-0 bg-white dark:bg-slate-800 p-6 border-b dark:border-slate-700 flex justify-between items-center">
                <h2 class="text-2xl font-bold text-slate-900 dark:text-white">Calculator</h2>
                <button onclick="closeModal('calculatorModal')" class="w-8 h-8 flex items-center justify-center text-slate-500 hover:text-slate-800 dark:hover:text-slate-200 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 transition-all">‚úï</button>
            </div>
            <div class="p-6">
                <div id="calcDisplay" class="w-full bg-slate-100 dark:bg-slate-900 rounded-lg p-4 text-right text-3xl font-bold text-slate-900 dark:text-white mb-4 break-all min-h-[60px]">0</div>
                <div class="grid grid-cols-4 gap-3">
                    <button class="calc-btn bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 col-span-2" onclick="clearCalc()">C</button>
                    <button class="calc-btn bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600" onclick="deleteCalc()">‚Üê</button>
                    <button class="calc-btn bg-blue-500 text-white hover:bg-blue-600" onclick="appendCalc('/')">/</button>
                    
                    <button class="calc-btn" onclick="appendCalc('7')">7</button>
                    <button class="calc-btn" onclick="appendCalc('8')">8</button>
                    <button class="calc-btn" onclick="appendCalc('9')">9</button>
                    <button class="calc-btn bg-blue-500 text-white hover:bg-blue-600" onclick="appendCalc('*')">√ó</button>

                    <button class="calc-btn" onclick="appendCalc('4')">4</button>
                    <button class="calc-btn" onclick="appendCalc('5')">5</button>
                    <button class="calc-btn" onclick="appendCalc('6')">6</button>
                    <button class="calc-btn bg-blue-500 text-white hover:bg-blue-600" onclick="appendCalc('-')">-</button>

                    <button class="calc-btn" onclick="appendCalc('1')">1</button>
                    <button class="calc-btn" onclick="appendCalc('2')">2</button>
                    <button class="calc-btn" onclick="appendCalc('3')">3</button>
                    <button class="calc-btn bg-blue-500 text-white hover:bg-blue-600" onclick="appendCalc('+')">+</button>

                    <button class="calc-btn col-span-2" onclick="appendCalc('0')">0</button>
                    <button class="calc-btn" onclick="appendCalc('.')">.</button>
                    <button class="calc-btn bg-green-500 text-white hover:bg-green-600" onclick="calculateCalc()">=</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- User Management Modal -->
    <div id="userModal" class="fixed inset-0 z-[1000] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4" style="display: none;">
        <div class="modal-content bg-white dark:bg-slate-800 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white dark:bg-slate-800 p-6 border-b dark:border-slate-700 flex justify-between items-center">
                <h2 class="text-2xl font-bold text-slate-900 dark:text-white">Manage Admins</h2>
                <button onclick="closeModal('userModal')" class="w-8 h-8 flex items-center justify-center text-slate-500 hover:text-slate-800 dark:hover:text-slate-200 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 transition-all">‚úï</button>
            </div>

            <div class="p-6 space-y-6">
                <div>
                    <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-4">Add New Admin</h3>
                    <form id="addUserForm" class="space-y-4">
                        <div>
                            <label for="newUserName" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Custom Name</label>
                            <input type="text" id="newUserName" placeholder="e.g., Elora" required class="form-input">
                        </div>
                        <div>
                            <label for="newUsername" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Login Username</label>
                            <input type="text" id="newUsername" placeholder="e.g., elora (no spaces, all lowercase)" required class="form-input">
                        </div>
                        <div>
                            <label for="newPassword" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Password</label>
                            <input type="password" id="newPassword" placeholder="Set a password" required class="form-input">
                        </div>
                        <div>
                            <label for="newProfitPercent" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Profit % (Commission)</label>
                            <input type="number" id="newProfitPercent" placeholder="e.g., 20" min="0" max="100" required class="form-input">
                            <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">This admin will earn this % from each sale's sell price.</p>
                        </div>
                        <button type="submit" class="w-full py-3 px-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-slate-800 transition-all">
                            ‚ûï Add Admin
                        </button>
                    </form>
                </div>
                
                <hr class="border-slate-200 dark:border-slate-700">

                <div>
                    <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-4">Admin List</h3>
                    <div id="userList" class="space-y-3">
                        <!-- Admin list rendered here -->
                        <div class="text-center p-6 text-slate-500 dark:text-slate-400">No admins yet.</div>
                    </div>
                </div>

                <hr class="border-slate-200 dark:border-slate-700">

                <div>
                    <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-4">Pending Payouts</h3>
                    <div id="payoutList" class="space-y-3">
                        <!-- Payout list rendered here -->
                        <div class="text-center p-6 text-slate-500 dark:text-slate-400">No pending payouts.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 z-[1000] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4" style="display: none;">
        <div class="modal-content bg-white dark:bg-slate-800 rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white dark:bg-slate-800 p-6 border-b dark:border-slate-700 flex justify-between items-center">
                <h2 class="text-2xl font-bold text-slate-900 dark:text-white">Settings</h2>
                <button onclick="closeModal('settingsModal')" class="w-8 h-8 flex items-center justify-center text-slate-500 hover:text-slate-800 dark:hover:text-slate-200 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 transition-all">‚úï</button>
            </div>
            
            <div class="p-6 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="themeSelect" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Theme Color</label>
                        <select id="themeSelect" class="form-input">
                            <option value="theme-blue">Blue (Default)</option>
                            <option value="theme-purple">Purple</option>
                            <option value="theme-green">Green</option>
                            <option value="theme-pink">Pink</option>
                            <option value="theme-orange">Orange</option>
                        </select>
                    </div>
                     <div>
                        <label for="lowStockThreshold" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Low Stock Alert</label>
                        <input type="number" id="lowStockThreshold" value="5" min="1" class="form-input">
                    </div>
                </div>

                <div class="p-4 bg-slate-50 dark:bg-slate-700/50 rounded-lg">
                    <label for="toggleDarkMode" class="flex justify-between items-center cursor-pointer">
                        <span class="font-medium text-slate-700 dark:text-slate-300">Dark Mode</span>
                        <div class="relative">
                            <input type="checkbox" id="toggleDarkMode" class="sr-only peer">
                            <div class="w-10 h-6 bg-slate-300 dark:bg-slate-600 rounded-full shadow-inner peer-checked:bg-blue-600"></div>
                            <div class="dot absolute w-4 h-4 bg-white rounded-full shadow top-1 left-1 transition-transform peer-checked:translate-x-4"></div>
                        </div>
                    </label>
                </div>
                
                <div class="pt-4 border-t dark:border-slate-700">
                    <h3 class="text-lg font-semibold text-red-600 dark:text-red-400 mb-2">Danger Zone</h3>
                    <div class="space-y-3">
                        <button id="btnClearAll" class="w-full py-2 px-4 bg-red-100 dark:bg-red-900/40 text-red-700 dark:text-red-300 hover:bg-red-200 dark:hover:bg-red-900/60 font-medium rounded-lg transition-all text-sm">
                            üóëÔ∏è Clear My Sales Data
                        </button>
                        <button id="btnResetAll" class="w-full py-2 px-4 bg-red-100 dark:bg-red-900/40 text-red-700 dark:text-red-300 hover:bg-red-200 dark:hover:bg-red-900/60 font-medium rounded-lg transition-all text-sm">
                            üî• Reset All App Data (Owner Only)
                        </button>
                    </div>
                </div>

            </div>

            <div class="bg-slate-50 dark:bg-slate-800/50 px-6 py-4 flex justify-end space-x-3 rounded-b-lg">
                <button onclick="closeModal('settingsModal')" class="py-2 px-4 bg-white dark:bg-slate-700 text-slate-700 dark:text-slate-300 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm text-sm font-medium hover:bg-slate-50 dark:hover:bg-slate-600 focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-slate-800 focus:ring-slate-400 transition-all">
                    Cancel
                </button>
                <button onclick="saveSettings()" class="py-2 px-4 bg-blue-600 text-white border border-transparent rounded-md shadow-sm text-sm font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-slate-800 focus:ring-blue-500 transition-all">
                    Save Settings
                </button>
            </div>
        </div>
    </div>


    <script>
        // ===================
        // TAILWIND STYLES
        // ===================
        const formInputClasses = "w-full px-4 py-3 bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all";
        const calcBtnClasses = "py-4 rounded-lg text-xl font-bold transition-all bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-600";
        const filterBtnClasses = "py-2 px-4 text-sm font-medium rounded-lg transition-all bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600";
        const filterBtnActiveClasses = "bg-blue-600 text-white hover:bg-blue-700";
        
        // ===================
        // APP CONFIGURATION
        // ===================
        const APP_NAME = 'sales-tracker'; 

        // ===================
        // FIREBASE CONFIGURATION
        // ===================
        const firebaseConfig = {
            apiKey: "AIzaSyDx-OMCr0Af1cdK-hX5dL50S0YIbrbv6TE",
            authDomain: "sales-tracker-462f0.firebaseapp.com",
            databaseURL: "https://sales-tracker-462f0-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "sales-tracker-462f0",
            storageBucket: "sales-tracker-462f0.firebasestorage.app",
            messagingSenderId: "1070379275425",
            appId: "1:1070379275425:web:9642bdf4ca37c6aa850ce0"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        function getRef(path) {
            return database.ref(APP_NAME + '/' + path);
        }
        console.log('‚úÖ Firebase initialized for app:', APP_NAME);

        // ===================
        // GLOBAL STATE
        // ===================
        let currentSession = null;
        let currentUsername = '';
        let sales = [];
        let users = [];
        let payouts = [];
        let products = [];
        let settings = {
            theme: 'theme-blue',
            darkMode: false,
            lowStockThreshold: 5
        };
        let calcValue = '0';
        let currentEditId = null; // Used for editing sales
        let confirmCallback = null; // Stores the function to run on confirmation

        // ===================
        // INITIALIZATION
        // ===================
        function init() {
            console.log('üöÄ Initializing...');
            checkAuth(); 
        }
        
        function loadApp() {
            console.log('üöÄ Auth passed, loading app...');
            applyDynamicStyles();
            setupEventListeners();
            loadAllData();
        }

        function checkAuth() {
            const session = localStorage.getItem('session');
            if (!session) {
                window.location.href = 'index.html';
                return;
            }
            
            try {
                currentSession = JSON.parse(session);
            } catch (e) {
                console.error("Failed to parse session, logging out.", e);
                localStorage.removeItem('session');
                window.location.href = 'index.html';
                return;
            }
            
            if (!currentSession || !currentSession.username) {
                 console.warn("Invalid session, logging out.");
                 localStorage.removeItem('session');
                 window.location.href = 'index.html';
                 return;
            }
            
            currentUsername = currentSession.username;
            console.log('‚úÖ Logged in as:', currentSession.customName);
            
            document.getElementById('userName').textContent = currentSession.customName;
            document.getElementById('userRole').textContent = currentSession.role === 'owner' ? 'üëë OWNER' : 'üë§ ADMIN';
            document.getElementById('userAvatar').textContent = currentSession.customName.charAt(0).toUpperCase();
            
            if (currentSession.role === 'owner') {
                document.getElementById('btnUsers').style.display = 'flex';
                document.getElementById('btnProducts').style.display = 'flex';
                document.getElementById('btnResetAll').style.display = 'block';
            } else {
                document.getElementById('userFilter').style.display = 'none';
                if(document.getElementById('adminColumn')) {
                    document.getElementById('adminColumn').style.display = 'none';
                }
                document.getElementById('dashboardSubtitle').textContent = currentSession.customName + "'s Dashboard";
                document.getElementById('btnResetAll').style.display = 'none';
            }
            
            // Check for saved dark mode
            if (localStorage.getItem('darkMode') === 'true') {
                document.documentElement.classList.add('dark');
                settings.darkMode = true;
            }
            
            loadApp();
        }

        // ===================
        // DATA LOADING
        // ===================
        function loadAllData() {
            // Load users
            getRef('users').on('value', (snapshot) => {
                const usersData = snapshot.val() || {};
                users = Object.values(usersData).sort((a, b) => a.customName.localeCompare(b.customName));
                
                if (currentSession.role === 'owner') {
                    const userFilter = document.getElementById('userFilter');
                    userFilter.innerHTML = '<option value="all">All Admins</option>';
                    users.forEach(user => {
                        if (user.role === 'admin') {
                            userFilter.innerHTML += `<option value="${user.id}">${user.customName}</option>`;
                        }
                    });
                }
                renderUserList();
            });

            // Load products
            getRef('products').on('value', (snapshot) => {
                const productsData = snapshot.val() || {};
                products = Object.values(productsData).sort((a, b) => a.name.localeCompare(b.name));
                console.log('‚úÖ Products loaded:', products.length);
                updateProductDropdown();
                renderProductList();
            });

            // Load sales
            getRef('sales').on('value', (snapshot) => {
                const salesData = snapshot.val() || {};
                sales = [];
                Object.keys(salesData).forEach(userKey => {
                    const userSales = salesData[userKey];
                    if (userSales) {
                        Object.values(userSales).forEach(sale => {
                            sales.push(sale);
                        });
                    }
                });
                sales.sort((a, b) => b.id - a.id); // Sort by most recent
                console.log('‚úÖ Sales loaded:', sales.length);
                updateUI();
            });

            // Load payouts
            getRef('payouts').on('value', (snapshot) => {
                const payData = snapshot.val() || {};
                payouts = Object.values(payData).sort((a, b) => b.id - a.id);
                renderPayoutList();
                autoCalculatePayouts();
            });

            // Load settings
            if (currentUsername) {
                getRef('settings/' + currentUsername).once('value').then((snapshot) => {
                    if (snapshot.exists()) {
                        settings = { ...settings, ...snapshot.val() }; // Merge defaults with saved
                    }
                    applySettings();
                });
            } else {
                 applySettings();
            }
        }

        // ===================
        // SETTINGS
        // ===================
        function saveSettings() {
            settings.theme = document.getElementById('themeSelect').value;
            settings.lowStockThreshold = parseInt(document.getElementById('lowStockThreshold').value);
            settings.darkMode = document.documentElement.classList.contains('dark');
            
            getRef('settings/' + currentUsername).set(settings)
                .then(() => {
                    applySettings();
                    showToast('‚úÖ Settings saved!', 'success');
                    closeModal('settingsModal');
                })
                .catch((error) => {
                    // ***** SYNTAX ERROR FIX *****
                    // The error was: 'M + error.message, 'error'
                    showToast('‚ùå Error: ' + error.message, 'error');
                });
        }

        function applySettings() {
            // Remove old theme
            document.body.className = document.body.className.replace(/theme-\w+/g, '');
            // Add new theme
            document.body.classList.add(settings.theme || 'theme-blue');
            
            // Apply Dark Mode
            const darkModeToggle = document.getElementById('toggleDarkMode');
            if (settings.darkMode) {
                document.documentElement.classList.add('dark');
                if (darkModeToggle) darkModeToggle.checked = true;
            } else {
                document.documentElement.classList.remove('dark');
                if (darkModeToggle) darkModeToggle.checked = false;
            }
            
            if (document.getElementById('themeSelect')) {
                document.getElementById('themeSelect').value = settings.theme;
            }
            if (document.getElementById('lowStockThreshold')) {
                document.getElementById('lowStockThreshold').value = settings.lowStockThreshold;
            }

            // Update theme colors for charts
            updateCharts();
        }

        function toggleDarkMode() {
            const isDark = document.documentElement.classList.toggle('dark');
            settings.darkMode = isDark;
            localStorage.setItem('darkMode', isDark); // Save preference
            
            // This is a manual settings save
            getRef('settings/' + currentUsername).set(settings)
                .then(() => {
                    applySettings(); // Re-apply settings and update charts
                    showToast(isDark ? 'üåô Dark mode enabled' : '‚òÄÔ∏è Light mode enabled', 'info');
                })
                .catch((error) => {
                    showToast('‚ùå Error saving dark mode: ' + error.message, 'error');
                });
        }

        // ===================
        // PRODUCT MANAGEMENT
        // ===================
        function handleProductNameSelect() {
            const select = document.getElementById('productNameSelect');
            const customInput = document.getElementById('newProductName');
            if (!select || !customInput) return;

            if (select.value === 'custom') {
                customInput.style.display = 'block';
                customInput.required = true;
                customInput.focus();
            } else {
                customInput.style.display = 'none';
                customInput.required = false;
                customInput.value = select.value === '' ? '' : select.value;
            }
        }

        function autoCalculateProductFields() {
            const buyPrice = parseFloat(document.getElementById('newBuyPrice').value) || 0;
            const sellPrice = parseFloat(document.getElementById('newSellPrice').value) || 0;
            
            if (buyPrice > 0 && sellPrice > 0 && sellPrice > buyPrice) {
                const margin = ((sellPrice - buyPrice) / buyPrice) * 100;
                const profit = sellPrice - buyPrice;
                
                document.getElementById('newMargin').value = margin.toFixed(2) + '%';
                
                const commission20 = (sellPrice * 20) / 100;
                const commission30 = (sellPrice * 30) / 100;
                const adminPrice20 = sellPrice - commission20;
                const adminPrice30 = sellPrice - commission30;
                
                document.getElementById('autoProfit').textContent = '‚Ç±' + profit.toFixed(2);
                document.getElementById('autoProfitPercent').textContent = margin.toFixed(2) + '%';
                document.getElementById('autoAdminPrice20').textContent = '‚Ç±' + adminPrice20.toFixed(2);
                document.getElementById('autoAdminPrice30').textContent = '‚Ç±' + adminPrice30.toFixed(2);
                
                document.getElementById('productCalculation').style.display = 'block';
            } else {
                document.getElementById('newMargin').value = '';
                document.getElementById('productCalculation').style.display = 'none';
            }
        }

        document.getElementById('addProductForm').addEventListener('submit', function(e) {
            e.preventDefault();
            if (currentSession.role !== 'owner') return;
            
            const buyPrice = parseFloat(document.getElementById('newBuyPrice').value);
            const sellPrice = parseFloat(document.getElementById('newSellPrice').value);
            
            if (!buyPrice || !sellPrice) {
                showToast('‚ùå Please enter valid buy and sell prices.', 'error');
                return;
            }
            if (buyPrice >= sellPrice) {
                showToast('‚ùå Sell Price must be higher than Buy Price.', 'error');
                return;
            }
            
            const selectValue = document.getElementById('productNameSelect').value;
            const customValue = document.getElementById('newProductName').value.trim();
            
            let productName = '';
            if (selectValue === 'custom') {
                if (!customValue) {
                    showToast('‚ùå Please enter a custom product name.', 'error');
                    return;
                }
                productName = customValue;
            } else if (selectValue === '') {
                showToast('‚ùå Please select or enter a product name.', 'error');
                return;
            } else {
                productName = selectValue;
            }
            
            const margin = ((sellPrice - buyPrice) / buyPrice) * 100; 
            const newProduct = {
                id: Date.now(),
                name: productName,
                buyPrice: buyPrice,
                sellPrice: sellPrice,
                margin: parseFloat(margin.toFixed(2)),
                createdDate: new Date().toISOString().split('T')[0],
                createdBy: currentSession.customName
            };
            
            getRef('products/' + newProduct.id).set(newProduct)
                .then(() => {
                    document.getElementById('addProductForm').reset();
                    handleProductNameSelect();
                    autoCalculateProductFields();
                    showToast('‚úÖ Product added successfully!', 'success');
                })
                .catch((error) => showToast('‚ùå Error: ' + error.message, 'error'));
        });

        function deleteProduct(productId) {
            if (currentSession.role !== 'owner') return;
            
            showConfirmationModal('Are you sure you want to delete this product?', false, null, () => {
                getRef('products/' + productId).remove()
                    .then(() => showToast('üóëÔ∏è Product deleted.', 'info'))
                    .catch((error) => showToast('‚ùå Error: ' + error.message, 'error'));
            });
        }

        function editProduct(productId) {
            if (currentSession.role !== 'owner') return;
            
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            // This is a workaround to set the value if it's not in the dropdown
            const select = document.getElementById('productNameSelect');
            const customInput = document.getElementById('newProductName');
            const options = Array.from(select.options).map(o => o.value);
            
            if (options.includes(product.name)) {
                select.value = product.name;
                customInput.style.display = 'none';
                customInput.required = false;
            } else {
                select.value = 'custom';
                customInput.style.display = 'block';
                customInput.required = true;
                customInput.value = product.name;
            }

            document.getElementById('newBuyPrice').value = product.buyPrice;
            document.getElementById('newSellPrice').value = product.sellPrice;
            
            autoCalculateProductFields();
            
            // Delete the old product
            getRef('products/' + productId).remove();
            
            document.getElementById('productModal').scrollTo({ top: 0, behavior: 'smooth' });
            showToast('üìù Edit mode: Product loaded into form. Make changes and click "Add Product" to save.', 'info');
        }

        function updateProductDropdown() {
            if (!currentSession) return; 

            const select = document.getElementById('productSelect');
            if (!select) return;
            select.innerHTML = '<option value="">-- Select Product --</option>';
            
            products.forEach(product => {
                const userCommissionPercent = currentSession.profitPercent || (currentSession.role === 'owner' ? 100 : 0);
                const commissionAmount = (product.sellPrice * userCommissionPercent) / 100;
                const adminPrice = product.sellPrice - commissionAmount;
                const displayPrice = currentSession.role === 'owner' ? product.sellPrice : adminPrice;
                
                select.innerHTML += `<option value="${product.id}">${product.name} - ‚Ç±${displayPrice.toFixed(2)}</option>`;
            });
        }

        function renderProductList() {
            const productList = document.getElementById('productList');
            if (!productList) return;
            
            if (products.length === 0) {
                productList.innerHTML = '<div class="text-center p-6 text-slate-500 dark:text-slate-400">No products yet.</div>';
                return;
            }
            
            productList.innerHTML = products.map(product => {
                const profit = product.sellPrice - product.buyPrice;
                const comm20 = (product.sellPrice * 20) / 100;
                const comm30 = (product.sellPrice * 30) / 100;
                const price20 = product.sellPrice - comm20;
                const price30 = product.sellPrice - comm30;
                
                return `
                    <div class="bg-slate-50 dark:bg-slate-700/50 p-4 rounded-lg border dark:border-slate-700">
                        <div class="flex justify-between items-center mb-3">
                            <div class="font-bold text-lg text-blue-600 dark:text-blue-400">${product.name}</div>
                            <div class="flex-shrink-0 space-x-2">
                                <button onclick="editProduct(${product.id})" class="py-1 px-3 bg-slate-200 dark:bg-slate-600 text-slate-700 dark:text-slate-200 text-xs font-medium rounded-md hover:bg-slate-300 dark:hover:bg-slate-500 transition-all">‚úèÔ∏è Edit</button>
                                <button onclick="deleteProduct(${product.id})" class="py-1 px-3 bg-red-100 dark:bg-red-900/40 text-red-600 dark:text-red-300 text-xs font-medium rounded-md hover:bg-red-200 dark:hover:bg-red-900/60 transition-all">üóëÔ∏è Delete</button>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3 text-sm">
                            <div class="bg-white dark:bg-slate-700 p-2 rounded-md"><span class="block text-xs text-slate-500 dark:text-slate-400">Buy Price</span><span class="font-medium">‚Ç±${product.buyPrice.toFixed(2)}</span></div>
                            <div class="bg-white dark:bg-slate-700 p-2 rounded-md"><span class="block text-xs text-slate-500 dark:text-slate-400">Sell Price</span><span class="font-medium">‚Ç±${product.sellPrice.toFixed(2)}</span></div>
                            <div class="bg-white dark:bg-slate-700 p-2 rounded-md"><span class="block text-xs text-slate-500 dark:text-slate-400">Margin</span><span class="font-medium">${product.margin}%</span></div>
                            <div class="bg-green-50 dark:bg-green-900/40 p-2 rounded-md"><span class="block text-xs text-green-600 dark:text-green-300">Owner Profit</span><span class="font-bold text-green-700 dark:text-green-300">‚Ç±${profit.toFixed(2)}</span></div>
                            <div class="bg-slate-100 dark:bg-slate-600 p-2 rounded-md"><span class="block text-xs text-slate-500 dark:text-slate-400">Admin (20%)</span><span class="font-medium">‚Ç±${price20.toFixed(2)}</span></div>
                            <div class="bg-slate-100 dark:bg-slate-600 p-2 rounded-md"><span class="block text-xs text-slate-500 dark:text-slate-400">Admin (30%)</span><span class="font-medium">‚Ç±${price30.toFixed(2)}</span></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ===================
        // SALE MANAGEMENT
        // ===================
        function displayProductDetails(productId) {
            const detailsCard = document.getElementById('productDetailsCard');
            const totalCard = document.getElementById('totalEarningsCard');
            
            if (!productId) {
                detailsCard.style.display = 'none';
                totalCard.style.display = 'none';
                return;
            }
            
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            const quantity = parseInt(document.getElementById('productQuantity').value) || 1;
            
            const userCommissionPercent = currentSession.profitPercent || (currentSession.role === 'owner' ? 100 : 0);
            const commissionAmount = (product.sellPrice * userCommissionPercent) / 100;
            const adminPrice = product.sellPrice - commissionAmount;
            
            const yourPrice = currentSession.role === 'owner' ? product.sellPrice : adminPrice;
            const yourProfit = currentSession.role === 'owner' ? (product.sellPrice - product.buyPrice) : commissionAmount;
            
            document.getElementById('displayBuyPrice').textContent = '‚Ç±' + product.buyPrice.toFixed(2);
            document.getElementById('displaySellPrice').textContent = '‚Ç±' + product.sellPrice.toFixed(2);
            document.getElementById('displayMargin').textContent = product.margin.toFixed(2) + '%';
            document.getElementById('displayCommission').textContent = userCommissionPercent + '%';
            document.getElementById('displayYourPrice').textContent = '‚Ç±' + yourPrice.toFixed(2);
            document.getElementById('displayCommissionAmount').textContent = '‚Ç±' + yourProfit.toFixed(2);
            
            const totalSale = yourPrice * quantity;
            const totalEarn = yourProfit * quantity;
            
            document.getElementById('displayTotalSale').textContent = '‚Ç±' + totalSale.toFixed(2);
            document.getElementById('displayTotalEarn').textContent = '‚Ç±' + totalEarn.toFixed(2);
            
            document.getElementById('productPrice').value = yourPrice;
            
            detailsCard.style.display = 'block';
            totalCard.style.display = 'block';
        }
        
        document.getElementById('addSaleForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const productId = parseInt(document.getElementById('productSelect').value);
            if (!productId) {
                showToast('‚ö†Ô∏è Please select a product', 'error');
                return;
            }
            
            const warrantyType = document.querySelector('input[name="warranty"]:checked');
            const accountType = document.querySelector('input[name="accountType"]:checked');
            
            if (!warrantyType) {
                showToast('‚ö†Ô∏è Please select warranty type.', 'error');
                return;
            }
            if (!accountType) {
                showToast('‚ö†Ô∏è Please select account type.', 'error');
                return;
            }
            
            const product = products.find(p => p.id === productId);
             if (!product) {
                showToast('‚ùå Product data not found, please reload.', 'error');
                return;
            }
            
            const quantity = parseInt(document.getElementById('productQuantity').value);
            const price = parseFloat(document.getElementById('productPrice').value);
            
            const userCommissionPercent = currentSession.profitPercent || (currentSession.role === 'owner' ? 100 : 0);
            const commissionAmount = (product.sellPrice * userCommissionPercent) / 100;
            const yourProfit = currentSession.role === 'owner' ? (product.sellPrice - product.buyPrice) : commissionAmount;
            
            const saleData = {
                userId: currentSession.id,
                userName: currentSession.customName,
                userCommissionPercent: userCommissionPercent,
                date: new Date().toISOString().split('T')[0],
                productId: productId,
                product: product.name,
                warranty: warrantyType.value,
                accountType: accountType.value,
                quantity: quantity,
                price: price,
                buyPrice: product.buyPrice,
                sellPrice: product.sellPrice,
                commission: yourProfit,
                sold: document.getElementById('productSoldStatus').value === 'yes'
            };
            
            const userKey = currentUsername.replace(/[.#$/[\]]/g, '_');
            
            if (currentEditId) {
                // UPDATE existing sale
                getRef('sales/' + userKey + '/' + currentEditId).update(saleData)
                    .then(() => {
                        showToast('‚úÖ Sale updated successfully!', 'success');
                        resetSaleForm();
                        autoCalculatePayouts();
                    })
                    .catch((error) => showToast('‚ùå Error: ' + error.message, 'error'));
            } else {
                // CREATE new sale
                const newSaleId = Date.now();
                saleData.id = newSaleId;
                // ***** TYPO FIX *****
                getRef('sales/' + userKey + '/' + newSaleId).set(saleData)
                    .then(() => {
                        showToast('‚úÖ Sale added successfully!', 'success');
                        resetSaleForm();
                        autoCalculatePayouts();
                    })
                    .catch((error) => showToast('‚ùå Error: ' + error.message, 'error'));
            }
        });

        function editSale(id) {
            const sale = sales.find(s => s.id === id);
            if (!sale) return;
            
            // Ensure the user editing is the user who made the sale, or the owner
            if (currentSession.role !== 'owner' && currentSession.id !== sale.userId) {
                showToast('‚ùå You can only edit your own sales.', 'error');
                return;
            }

            currentEditId = id;

            document.getElementById('productSelect').value = sale.productId;
            document.querySelector(`input[name="warranty"][value="${sale.warranty}"]`).checked = true;
            document.querySelector(`input[name="accountType"][value="${sale.accountType}"]`).checked = true;
            document.getElementById('productQuantity').value = sale.quantity;
            document.getElementById('productSoldStatus').value = sale.sold ? 'yes' : 'no';
            
            // Manually trigger display update
            displayProductDetails(sale.productId);
            
            // Update UI
            document.getElementById('saleFormTitle').textContent = '‚úèÔ∏è Edit Sale';
            document.getElementById('submitSaleBtn').textContent = 'üíæ Update Sale';
            document.getElementById('cancelEditBtn').style.display = 'block';
            document.getElementById('addSaleForm').scrollIntoView({ behavior: 'smooth' });
        }

        function resetSaleForm() {
            currentEditId = null;
            document.getElementById('addSaleForm').reset();
            document.getElementById('productDetailsCard').style.display = 'none';
            document.getElementById('totalEarningsCard').style.display = 'none';
            document.getElementById('saleFormTitle').textContent = '‚ûï Add New Sale';
            document.getElementById('submitSaleBtn').textContent = '‚ûï Add Sale';
            document.getElementById('cancelEditBtn').style.display = 'none';
        }

        function deleteSale(id) {
            showConfirmationModal('Are you sure you want to delete this sale?', false, null, () => {
                const sale = sales.find(s => s.id === id);
                if (!sale) return;

                // Ensure the user deleting is the user who made the sale, or the owner
                if (currentSession.role !== 'owner' && currentSession.id !== sale.userId) {
                    showToast('‚ùå You can only delete your own sales.', 'error');
                    return;
                }
                
                // Find the username who made the sale
                const saleUser = users.find(u => u.id === sale.userId);
                if (!saleUser) {
                    showToast('‚ùå Cannot find original user for this sale.', 'error');
                    return;
                }
                const userKey = saleUser.username.replace(/[.#$/[\]]/g, '_');
                
                getRef('sales/' + userKey + '/' + id).remove()
                    .then(() => {
                        showToast('üóëÔ∏è Sale deleted.', 'info');
                        autoCalculatePayouts();
                    })
                    .catch((error) => showToast('‚ùå Error: ' + error.message, 'error'));
            });
        }

        function toggleSold(id) {
            const sale = sales.find(s => s.id === id);
            if (!sale) return;

            // Ensure the user toggling is the user who made the sale, or the owner
            if (currentSession.role !== 'owner' && currentSession.id !== sale.userId) {
                showToast('‚ùå You can only edit your own sales.', 'error');
                return;
            }
            
            const newSoldStatus = !sale.sold;
            
            const saleUser = users.find(u => u.id === sale.userId);
            if (!saleUser) {
                showToast('‚ùå Cannot find original user for this sale.', 'error');
                return;
            }
            const userKey = saleUser.username.replace(/[.#$/[\]]/g, '_');
            
            // ***** TYPO FIX *****
            getRef('sales/' + userKey + '/' + id).update({ sold: newSoldStatus })
                .then(() => {
                    showToast(newSoldStatus ? '‚úÖ Marked as sold!' : 'üì¶ Marked as in stock', 'success');
                    autoCalculatePayouts();
                })
                .catch((error) => showToast('‚ùå Error: ' + error.message, 'error'));
        }

        // ===================
        // USER & PAYOUTS
        // ===================
        function autoCalculatePayouts() {
            if (!currentSession || currentSession.role !== 'owner') return;
            
            const adminUsers = users.filter(u => u.role === 'admin');
            
            adminUsers.forEach(user => {
                const userSales = sales.filter(s => s.userId === user.id && s.sold);
                
                const totalCommission = userSales.reduce((sum, s) => {
                    return sum + ((s.commission || 0) * s.quantity);
                }, 0);
                
                const existingPayout = payouts.find(p => p.userId === user.id && p.status === 'pending');

                if (totalCommission > 0) {
                    if (existingPayout) {
                        getRef('payouts/' + existingPayout.id).update({
                            amount: totalCommission,
                            date: new Date().toISOString().split('T')[0]
                        });
                    } else {
                        const payout = {
                            id: Date.now() + user.id, // Unique ID
                            userId: user.id,
                            userName: user.customName,
                            amount: totalCommission,
                            date: new Date().toISOString().split('T')[0],
                            status: 'pending'
                        };
                        getRef('payouts/' + payout.id).set(payout);
                    }
                } else if (existingPayout) {
                    // If commission is 0 but a pending payout exists, remove it
                    getRef('payouts/' + existingPayout.id).remove();
                }
            });
        }

        function markPaid(payoutId) {
             showConfirmationModal('Mark this payout as paid?', false, null, () => {
                getRef('payouts/' + payoutId).update({ status: 'paid' })
                    .then(() => showToast('‚úÖ Marked as paid!', 'success'))
                    .catch((error) => showToast('‚ùå Error: ' + error.message, 'error'));
            });
        }

        function renderPayoutList() {
            const payoutList = document.getElementById('payoutList');
            if (!payoutList) return;

            const pendingPayouts = payouts.filter(p => p.status === 'pending');
            
            if (pendingPayouts.length === 0) {
                payoutList.innerHTML = '<div class="text-center p-6 text-slate-500 dark:text-slate-400">No pending payouts.</div>';
                return;
            }
            
            payoutList.innerHTML = pendingPayouts.map(payout => `
                <div class="bg-slate-50 dark:bg-slate-700/50 p-4 rounded-lg border dark:border-slate-700 flex justify-between items-center">
                    <div>
                        <div class="font-semibold text-slate-800 dark:text-slate-200">${payout.userName}</div>
                        <div class="text-xl font-bold text-green-600 dark:text-green-400">‚Ç±${payout.amount.toFixed(2)}</div>
                        <div class="text-xs text-slate-500 dark:text-slate-400">Pending since: ${payout.date}</div>
                    </div>
                    <button onclick="markPaid(${payout.id})" class="py-2 px-4 bg-green-600 text-white font-medium rounded-lg text-sm hover:bg-green-700 transition-all">
                        ‚úÖ Mark Paid
                    </button>
                </div>
            `).join('');
        }

        document.getElementById('addUserForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('newUsername').value.trim().toLowerCase(); // Force lowercase for key
            const customName = document.getElementById('newUserName').value.trim();
            const password = document.getElementById('newPassword').value;
            const profitPercent = parseFloat(document.getElementById('newProfitPercent').value);

            if (!username || !customName || !password || isNaN(profitPercent)) {
                showToast('‚ùå Please fill out all fields.', 'error');
                return;
            }
            if (username.includes(' ') || username.includes('.')) {
                showToast('‚ùå Username cannot contain spaces or periods.', 'error');
                return;
            }

            getRef('users/' + username).once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        showToast('‚ùå Username already exists!', 'error');
                        return Promise.reject('Username exists');
                    }

                    const newUser = {
                        id: Date.now(),
                        customName: customName,
                        username: username,
                        password: password,
                        role: 'admin',
                        profitPercent: profitPercent,
                        createdDate: new Date().toISOString().split('T')[0]
                    };

                    // ***** TYPO FIX *****
                    return getRef('users/' + username).set(newUser);
                })
                .then(() => {
                    document.getElementById('addUserForm').reset();
                    showToast('‚úÖ Admin added successfully!', 'success');
                })
                .catch((error) => {
                    if (error && error.message) {
                        showToast('‚ùå Error: ' + error.message, 'error');
                    } else if (error !== 'Username exists') {
                         showToast('‚ùå An unknown error occurred.', 'error');
                    }
                });
        });

        function deleteUser(userId) {
            showConfirmationModal('Delete this admin? Their sales will remain.', false, null, () => {
                const user = users.find(u => u.id === userId);
                if (!user) return;
                
                getRef('users/' + user.username).remove()
                    .then(() => getRef('payouts').orderByChild('userId').equalTo(userId).once('value'))
                    .then((snapshot) => {
                        const deletePromises = [];
                        snapshot.forEach((child) => {
                            deletePromises.push(getRef('payouts/' + child.key).remove());
                        });
                        return Promise.all(deletePromises);
                    })
                    .then(() => showToast('üóëÔ∏è Admin deleted', 'info'))
                    .catch((error) => showToast('‚ùå Error: ' + error.message, 'error'));
            });
        }

        function renderUserList() {
            const userList = document.getElementById('userList');
            if (!userList) return;
            const adminUsers = users.filter(u => u.role === 'admin');
            
            if (adminUsers.length === 0) {
                userList.innerHTML = '<div class="text-center p-6 text-slate-500 dark:text-slate-400">No admins yet.</div>';
                return;
            }
            
            userList.innerHTML = adminUsers.map(user => {
                const userSales = sales.filter(s => s.userId === user.id && s.sold);
                const totalCommission = userSales.reduce((sum, s) => sum + ((s.commission || 0) * s.quantity), 0);
                
                return `
                    <div class="bg-slate-50 dark:bg-slate-700/50 p-4 rounded-lg border dark:border-slate-700 flex justify-between items-center">
                        <div>
                            <div class="font-semibold text-slate-800 dark:text-slate-200">${user.customName} <span class="text-xs text-slate-500 dark:text-slate-400">(@${user.username})</span></div>
                            <div class="text-sm text-slate-600 dark:text-slate-300">Rate: ${user.profitPercent}% ‚Ä¢ Earned (All Time): ‚Ç±${totalCommission.toFixed(2)}</div>
                        </div>
                        <button onclick="deleteUser(${user.id})" class="py-1 px-3 bg-red-100 dark:bg-red-900/40 text-red-600 dark:text-red-300 text-xs font-medium rounded-md hover:bg-red-200 dark:hover:bg-red-900/60 transition-all">
                            üóëÔ∏è Delete
                        </button>
                    </div>
                `;
            }).join('');
        }

        // ===================
        // UI & CHARTS
        // ===================
        function updateUI() {
            if (!currentSession) return;
            updateStats();
            renderSalesTable();
            updateCharts();
        }

        function getFilteredSales() {
            const activePeriodTab = document.querySelector('.period-tab.active');
            if (!activePeriodTab) return sales; 

            const activePeriod = activePeriodTab.dataset.period;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            let filtered = sales;
            
            if (currentSession.role === 'admin') {
                filtered = filtered.filter(s => s.userId === currentSession.id);
            } else {
                const userFilter = document.getElementById('userFilter');
                if (userFilter) {
                    const selectedUserId = userFilter.value;
                    if (selectedUserId && selectedUserId !== 'all') {
                        filtered = filtered.filter(s => s.userId === parseInt(selectedUserId));
                    }
                }
            }
            
            if (activePeriod === 'today') {
                filtered = filtered.filter(s => s.date === today.toISOString().split('T')[0]);
            } else if (activePeriod === 'week') {
                const weekAgo = new Date(today);
                weekAgo.setDate(weekAgo.getDate() - 7);
                filtered = filtered.filter(s => new Date(s.date) >= weekAgo);
            } else if (activePeriod === 'month') {
                const monthAgo = new Date(today);
                monthAgo.setMonth(monthAgo.getMonth() - 1);
                filtered = filtered.filter(s => new Date(s.date) >= monthAgo);
            }
            
            return filtered;
        }

        function updateStats() {
            const filtered = getFilteredSales();
            const soldItems = filtered.filter(s => s.sold);
            
            const totalSales = soldItems.reduce((sum, s) => sum + (s.price * s.quantity), 0);
            const totalProducts = filtered.reduce((sum, s) => sum + s.quantity, 0);
            const itemsSold = soldItems.reduce((sum, s) => sum + s.quantity, 0);
            const avgSale = itemsSold > 0 ? totalSales / itemsSold : 0;
            
            let myEarnings = 0;
            if (currentSession.role === 'admin') {
                const mySales = soldItems.filter(s => s.userId === currentSession.id);
                myEarnings = mySales.reduce((sum, s) => sum + ((s.commission || 0) * s.quantity), 0);
            } else {
                const allAdminCommissions = soldItems.reduce((sum, s) => {
                    if (s.userId !== currentSession.id) { 
                        return sum + ((s.commission || 0) * s.quantity);
                    }
                    return sum;
                }, 0);
                myEarnings = totalSales - allAdminCommissions;
            }
            
            document.getElementById('totalSales').textContent = '‚Ç±' + totalSales.toFixed(2);
            document.getElementById('totalProducts').textContent = totalProducts;
            document.getElementById('itemsSold').textContent = itemsSold;
            document.getElementById('avgSale').textContent = '‚Ç±' + avgSale.toFixed(2);
            document.getElementById('myEarnings').textContent = '‚Ç±' + myEarnings.toFixed(2);
            document.getElementById('profitRate').textContent = (currentSession.profitPercent || (currentSession.role === 'owner' ? 100 : 0)) + '%';
        }

        function renderSalesTable() {
            const tbody = document.getElementById('salesTableBody');
            const filtered = getFilteredSales();
            
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            let displaySales = filtered;
            
            if (searchTerm) {
                displaySales = filtered.filter(s => 
                    s.product.toLowerCase().includes(searchTerm) ||
                    s.userName.toLowerCase().includes(searchTerm) ||
                    s.warranty.toLowerCase().includes(searchTerm) ||
                    s.accountType.toLowerCase().includes(searchTerm)
                );
            }
            
            const activeFilterBtn = document.querySelector('.filter-btn.active');
            const activeFilter = activeFilterBtn ? activeFilterBtn.id : 'filterAll';
            
            if (activeFilter === 'filterSold') {
                displaySales = displaySales.filter(s => s.sold);
            } else if (activeFilter === 'filterStock') {
                displaySales = displaySales.filter(s => !s.sold);
            }
            
            if (displaySales.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" class="p-6 text-center text-slate-500 dark:text-slate-400">
                            No sales found for the current filters.
                        </td>
                    </tr>`;
                return;
            }
            
            tbody.innerHTML = displaySales.map(sale => `
                <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50">
                    <td class="p-4 text-sm text-slate-700 dark:text-slate-300">${sale.date}</td>
                    ${currentSession.role === 'owner' ? `<td class="p-4 text-sm font-medium text-slate-900 dark:text-white">${sale.userName}</td>` : ''}
                    <td class="p-4 text-sm font-medium text-slate-900 dark:text-white">${sale.product}</td>
                    <td class="p-4 text-sm"><span class="warranty-badge ${sale.warranty.toLowerCase()}">${sale.warranty}</span></td>
                    <td class="p-4 text-sm"><span class="account-type-badge ${sale.accountType.toLowerCase()}">${sale.accountType}</span></td>
                    <td class="p-4 text-sm text-slate-700 dark:text-slate-300">${sale.quantity}</td>
                    <td class="p-4 text-sm text-slate-700 dark:text-slate-300">‚Ç±${sale.price.toFixed(2)}</td>
                    <td class="p-4 text-sm font-bold text-blue-600 dark:text-blue-400">‚Ç±${(sale.price * sale.quantity).toFixed(2)}</td>
                    <td class="p-4 text-sm">
                        <span class="cursor-pointer" onclick="toggleSold(${sale.id})">
                            ${sale.sold ? '‚úÖ' : '‚ùå'}
                        </span>
                    </td>
                    <td class="p-4 text-sm space-x-2">
                        <button onclick="editSale(${sale.id})" class="py-1 px-2 bg-slate-200 dark:bg-slate-600 text-slate-700 dark:text-slate-200 text-xs font-medium rounded-md hover:bg-slate-300 dark:hover:bg-slate-500 transition-all">‚úèÔ∏è</button>
                        <button onclick="deleteSale(${sale.id})" class="py-1 px-2 bg-red-100 dark:bg-red-900/40 text-red-600 dark:text-red-300 text-xs font-medium rounded-md hover:bg-red-200 dark:hover:bg-red-900/60 transition-all">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');

            // After rendering, apply dynamic styles to the new badges
            applyDynamicStyles();
        }

        function updateCharts() {
            const filtered = getFilteredSales();
            const soldItems = filtered.filter(s => s.sold);
            
            // Group sales by date
            const salesByDateMap = soldItems.reduce((acc, sale) => {
                const date = sale.date;
                const total = (sale.price || 0) * (sale.quantity || 0);
                acc[date] = (acc[date] || 0) + total;
                return acc;
            }, {});
            
            const sortedDates = Object.keys(salesByDateMap).sort((a,b) => new Date(a) - new Date(b));
            const salesByDate = sortedDates.map(date => salesByDateMap[date]);

            // Group by warranty
            const fwSales = soldItems.filter(s => s.warranty === 'FW').reduce((sum, s) => sum + (s.price * s.quantity), 0);
            const nwSales = soldItems.filter(s => s.warranty === 'NW').reduce((sum, s) => sum + (s.price * s.quantity), 0);
            
            // Chart.js Contexts
            const salesCtx = document.getElementById('salesChart')?.getContext('2d');
            const warrantyCtx = document.getElementById('warrantyChart')?.getContext('2d');
            if (!salesCtx || !warrantyCtx) return;

            const isDark = document.documentElement.classList.contains('dark');
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            const textColor = isDark ? '#cbd5e1' : '#334155';

            // Sales Chart
            if (window.salesChart && typeof window.salesChart.destroy === 'function') {
                window.salesChart.destroy();
            }
            window.salesChart = new Chart(salesCtx, {
                type: 'line',
                data: {
                    labels: sortedDates,
                    datasets: [{
                        label: 'Sales (‚Ç±)',
                        data: salesByDate,
                        borderColor: '#3B82F6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { ticks: { color: textColor }, grid: { color: gridColor } },
                        x: { ticks: { color: textColor }, grid: { color: gridColor } }
                    },
                    plugins: { legend: { labels: { color: textColor } } }
                }
            });
            
            // Warranty Chart
            if (window.warrantyChart && typeof window.warrantyChart.destroy === 'function') {
                window.warrantyChart.destroy();
            }
            window.warrantyChart = new Chart(warrantyCtx, {
                type: 'doughnut',
                data: {
                    labels: ['FW (Full Warranty)', 'NW (No Warranty)'],
                    datasets: [{
                        data: [fwSales, nwSales],
                        backgroundColor: ['#10B981', '#F59E0B']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: textColor } }
                    }
                }
            });
        }

        // ===================
        // UTILITY FUNCTIONS
        // ===================

        function applyDynamicStyles() {
            // Apply to all elements matching the class
            document.querySelectorAll('.form-input').forEach(el => {
                formInputClasses.split(' ').forEach(cls => el.classList.add(cls));
            });
            document.querySelectorAll('.calc-btn').forEach(el => {
                calcBtnClasses.split(' ').forEach(cls => el.classList.add(cls));
            });
            document.querySelectorAll('.filter-btn').forEach(el => {
                // Clear old classes
                filterBtnClasses.split(' ').forEach(cls => el.classList.remove(cls));
                filterBtnActiveClasses.split(' ').forEach(cls => el.classList.remove(cls));

                if (el.classList.contains('active')) {
                    filterBtnActiveClasses.split(' ').forEach(cls => el.classList.add(cls));
                } else {
                    filterBtnClasses.split(' ').forEach(cls => el.classList.add(cls));
                }
            });
            document.querySelectorAll('.warranty-badge.fw').forEach(el => el.className = 'warranty-badge fw py-1 px-2 text-xs font-medium rounded-full bg-green-100 dark:bg-green-900/40 text-green-700 dark:text-green-300');
            document.querySelectorAll('.warranty-badge.nw').forEach(el => el.className = 'warranty-badge nw py-1 px-2 text-xs font-medium rounded-full bg-yellow-100 dark:bg-yellow-900/40 text-yellow-700 dark:text-yellow-300');
            document.querySelectorAll('.account-type-badge.solo').forEach(el => el.className = 'account-type-badge solo py-1 px-2 text-xs font-medium rounded-full bg-blue-100 dark:bg-blue-900/40 text-blue-700 dark:text-blue-300');
            document.querySelectorAll('.account-type-badge.shared').forEach(el => el.className = 'account-type-badge shared py-1 px-2 text-xs font-medium rounded-full bg-purple-100 dark:bg-purple-900/40 text-purple-700 dark:text-purple-300');
        }


        function exportToCSV() {
            const filtered = getFilteredSales();
            if (filtered.length === 0) return showToast('‚ö†Ô∏è No data to export', 'error');
            
            let csv = 'Date,Admin,Product,Warranty,Type,Quantity,Price,Total,Commission,Sold\n';
            filtered.forEach(sale => {
                csv += `${sale.date},${sale.userName},"${sale.product}",${sale.warranty},${sale.accountType},${sale.quantity},${sale.price},${(sale.price * sale.quantity).toFixed(2)},${((sale.commission || 0) * sale.quantity).toFixed(2)},${sale.sold ? 'Yes' : 'No'}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sales_export_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            showToast('üì• CSV exported successfully!', 'success');
        }

        function clearAllData() {
            showConfirmationModal('Delete ALL your sales data? This cannot be undone. Type "DELETE ALL" to confirm.', true, "DELETE ALL", () => {
                const userKey = currentUsername.replace(/[.#$/[\]]/g, '_');
                getRef('sales/'s + userKey).remove()
                    .then(() => {
                        showToast('üóëÔ∏è All your data cleared!', 'info');
                        autoCalculatePayouts();
                    })
                    .catch((error) => showToast('‚ùå Error: ' + error.message, 'error'));
            });
        }
        
        function resetAllData() {
            if (currentSession.role !== 'owner') {
                showToast('‚ùå Only owner can reset data.', 'error');
                return;
            }
            showConfirmationModal('Delete ALL products, sales, and payouts? This will reset everything to zero! Type "RESET" to confirm.', true, "RESET", () => {
                showToast('üîÑ Resetting all data...', 'info');
                Promise.all([
                    getRef('sales').remove(),
                    getRef('products').remove(),
                    getRef('payouts').remove()
                ])
                .then(() => {
                    showToast('‚úÖ All data reset! Reloading...', 'success');
                    setTimeout(() => location.reload(), 2000);
                })
                .catch((error) => showToast('‚ùå Error: ' + error.message, 'error'));
            });
        }

        // ===================
        // CALCULATOR
        // ===================
        function appendCalc(value) {
            if (calcValue === '0' && value !== '.') {
                calcValue = value;
            } else {
                calcValue += value;
            }
            document.getElementById('calcDisplay').textContent = calcValue;
        }

        function clearCalc() {
            calcValue = '0';
            document.getElementById('calcDisplay').textContent = calcValue;
        }

        function deleteCalc() {
            calcValue = calcValue.slice(0, -1);
            if (calcValue === '') calcValue = '0';
            document.getElementById('calcDisplay').textContent = calcValue;
        }

        function calculateCalc() {
            try {
                let safeExpression = calcValue.replace('√ó', '*').replace('√∑', '/');
                // Sanitize: allow only numbers, operators, and dots
                if (/[^0-9\+\-\*\/\.]/.test(safeExpression)) {
                    throw new Error("Invalid characters");
                }
                calcValue = Function('"use strict";return (' + safeExpression + ')')().toString();
                document.getElementById('calcDisplay').textContent = calcValue;
            } catch (e) {
                calcValue = 'Error';
                document.getElementById('calcDisplay').textContent = calcValue;
                setTimeout(() => { calcValue = '0'; document.getElementById('calcDisplay').textContent = calcValue; }, 1500);
            }
        }

        // ===================
        // MODAL & TOAST HANDLERS
        // ===================
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const iconEl = document.getElementById('toastIcon');
            const msgEl = document.getElementById('toastMessage');
            
            const icons = { success: '‚úÖ', error: '‚ùå', info: '‚ÑπÔ∏è' };
            const colors = {
                success: 'bg-green-100 dark:bg-green-900/40 text-green-700 dark:text-green-300 border-green-300 dark:border-green-700',
                error: 'bg-red-100 dark:bg-red-900/40 text-red-700 dark:text-red-300 border-red-300 dark:border-red-700',
                info: 'bg-blue-100 dark:bg-blue-900/40 text-blue-700 dark:text-blue-300 border-blue-300 dark:border-blue-700'
            };
            
            // Reset classes
            toast.className = "fixed bottom-5 right-5 z-[1001] flex items-center w-full max-w-xs p-4 rounded-lg shadow-lg text-slate-700 bg-white dark:text-slate-300 dark:bg-slate-800 border dark:border-slate-700 transition-transform translate-x-[120%]";
            toast.classList.add(...colors[type].split(' '));
            
            iconEl.textContent = icons[type];
            msgEl.textContent = message;
            
            // Show toast
            toast.style.transform = 'translateX(0)';
            // Hide after 3 seconds
            setTimeout(() => {
                toast.style.transform = 'translateX(120%)';
            }, 3000);
        }
        
        function showConfirmationModal(message, requiresInput = false, expectedInput = "", onConfirm = () => {}) {
            const modal = document.getElementById('confirmationModal');
            document.getElementById('confirmMessage').textContent = message;
            const inputWrapper = document.getElementById('confirmInputWrapper');
            const input = document.getElementById('confirmInput');
            const okBtn = document.getElementById('confirmOkBtn');
            
            if (requiresInput) {
                inputWrapper.style.display = 'block';
                input.value = '';
                input.placeholder = `Type "${expectedInput}" to confirm`;
                okBtn.disabled = true;
                okBtn.classList.add('opacity-50', 'cursor-not-allowed');
                
                // Add real-time validation
                input.oninput = () => {
                    if (input.value === expectedInput) {
                        okBtn.disabled = false;
                        okBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    } else {
                        okBtn.disabled = true;
                        okBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    }
                };
            } else {
                inputWrapper.style.display = 'none';
                input.oninput = null;
                okBtn.disabled = false;
                okBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
            
            // Store the callback
            confirmCallback = onConfirm;
            modal.style.display = 'flex';
        }

        function closeConfirmationModal() {
            document.getElementById('confirmationModal').style.display = 'none';
            confirmCallback = null; // Clear callback
        }

        // ===================
        // EVENT LISTENERS
        // ===================
        function setupEventListeners() {
            // Period Tabs
            document.querySelectorAll('.period-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.period-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    applyDynamicStyles(); // Update tab styles
                    updateUI();
                });
            });
            
            // Search & Filter
            document.getElementById('searchInput').addEventListener('input', renderSalesTable);
            document.getElementById('userFilter').addEventListener('change', updateUI);
            
            const filterButtons = ['filterAll', 'filterSold', 'filterStock'];
            filterButtons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    btn.addEventListener('click', function() {
                        filterButtons.forEach(id => document.getElementById(id)?.classList.remove('active'));
                        this.classList.add('active');
                        applyDynamicStyles(); // Update filter btn styles
                        renderSalesTable();
                    });
                }
            });
            
            // Nav Buttons
            document.getElementById('btnUsers').addEventListener('click', () => openModal('userModal'));
            document.getElementById('btnProducts').addEventListener('click', () => openModal('productModal'));
            document.getElementById('btnCalculator').addEventListener('click', () => openModal('calculatorModal'));
            document.getElementById('btnSettings').addEventListener('click', () => openModal('settingsModal'));
            document.getElementById('btnDark').addEventListener('click', toggleDarkMode);
            document.getElementById('btnLogout').addEventListener('click', () => {
                showConfirmationModal('Are you sure you want to logout?', false, null, () => {
                    localStorage.removeItem('session');
                    localStorage.removeItem('darkMode'); // Clear dark mode preference
                    window.location.href = 'index.html';
                });
            });
            
            // Export & Clear
            document.getElementById('btnExport').addEventListener('click', exportToCSV);
            document.getElementById('btnClearAll').addEventListener('click', clearAllData);
            document.getElementById('btnResetAll').addEventListener('click', resetAllData);
            
            // Settings Modal
            document.getElementById('toggleDarkMode').addEventListener('change', () => {
                // This is for the toggle switch
                const isDark = document.getElementById('toggleDarkMode').checked;
                if (isDark) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
                settings.darkMode = isDark;
                localStorage.setItem('darkMode', isDark);
            });
            
            // Confirmation Modal Buttons
            document.getElementById('confirmCancelBtn').addEventListener('click', closeConfirmationModal);
            document.getElementById('confirmOkBtn').addEventListener('click', () => {
                if (confirmCallback) {
                    confirmCallback();
                }
                closeConfirmationModal();
            });

            // Product Modal Price Calculation
            document.getElementById('newBuyPrice').addEventListener('input', autoCalculateProductFields);
            document.getElementById('newSellPrice').addEventListener('input', autoCalculateProductFields);
            
            // Sale Form Product/Qty Change
            document.getElementById('productSelect').addEventListener('change', (e) => displayProductDetails(parseInt(e.target.value)));
            document.getElementById('productQuantity').addEventListener('input', () => displayProductDetails(parseInt(document.getElementById('productSelect').value)));

            // Global modal close on outside click
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeModal(modal.id);
                    }
                });
            });
        }

        // ===================
        // START THE APP
        // ===================
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
